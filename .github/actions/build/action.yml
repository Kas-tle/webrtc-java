name: "Gradle Build"

description: "Build the platform dependent Java library"

inputs:
  java-version:
    description: "The Java build version."
    required: true
    default: "17"

  platform-name:
    description: "The target platform."
    required: true

runs:
  using: "composite"
  steps:
    - name: Create WebRTC checkout folder
      run: |
        mkdir -p $HOME/webrtc
        echo "WEBRTC_CHECKOUT_FOLDER=$HOME/webrtc" >> $GITHUB_ENV
      shell: bash

    - name: Set up WebRTC cache
      uses: actions/cache@9255dc7a253b0ccc959486e2bca901246202afeb
      # https://github.com/actions/cache/releases/latest
      with:
        path: ${{ env.WEBRTC_CHECKOUT_FOLDER }}/build
        key: webrtc-${{ hashFiles('webrtc-jni/gradle.properties') }}-${{ inputs.platform-name }}-${{ hashFiles('webrtc-jni/src/main/cpp/dependencies/webrtc/CMakeLists.txt') }}
        restore-keys: webrtc-${{ hashFiles('webrtc-jni/gradle.properties') }}-${{ inputs.platform-name }}-

    - uses: actions/setup-java@f2beeb24e141e01a676f977032f5a29d81c9e27e
      # https://github.com/actions/setup-java/releases/latest
      with:
        distribution: 'temurin'
        java-version: ${{ inputs.java-version }}

    - uses: gradle/actions/setup-gradle@4d9f0ba0025fe599b4ebab900eb7f3a1d93ef4c2
      # https://github.com/gradle/actions/releases/latest

    - name: Build
      env:
        WEBRTC_PLATFORM: ${{ inputs.platform-name }}
        SKIP_TESTS: ${{ inputs.platform-name == 'linux-aarch32' || inputs.platform-name == 'linux-aarch64' || inputs.platform-name == 'macos-x86_64' }}
      run: ./gradlew build
      shell: bash

    - name: Archive webrtc-java
      uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f
      # https://github.com/actions/upload-artifact/releases/latest
      with:
        name: webrtc-java-${{ inputs.platform-name }}
        path: webrtc/build/libs/*.jar

    - name: Archive webrtc-java-jni
      uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f
      # https://github.com/actions/upload-artifact/releases/latest
      with:
        name: webrtc-java-jni-${{ inputs.platform-name }}
        path: webrtc-jni/build/libs/*.jar
