name: "Gradle Test"

description: "Test the platform dependent Java library"

inputs:
  java-version:
    description: "The Java build version."
    required: true
    default: "17"

  platform-name:
    description: "The target platform."
    required: true

  architecture:
    description: "The target architecture."
    required: false
    default: ""

runs:
  using: "composite"
  steps:
    - name: Install 32-bit ARM libraries
      if: inputs.architecture == 'armv7'
      run: |
        sudo dpkg --add-architecture armhf
        sudo apt-get update
        sudo apt-get install -y libc6:armhf libstdc++6:armhf zlib1g:armhf
      shell: bash

    - uses: actions/setup-java@f2beeb24e141e01a676f977032f5a29d81c9e27e
      # https://github.com/actions/setup-java/releases/latest
      with:
        distribution: "liberica"
        java-version: ${{ inputs.java-version }}
        architecture: ${{ inputs.architecture }}

    - name: Debug 32-bit environment
      if: inputs.architecture == 'armv7'
      run: |
          echo "Checking for dynamic loader..."
          ls -l /lib/ld-linux-armhf.so.3 || echo "Loader not found in /lib"
          ls -l /usr/lib/arm-linux-gnueabihf/ || echo "Library path not found"
          
          echo "Checking binary dependencies..."
          JAVA_BIN=$(find /opt/hostedtoolcache -name java | grep armv7 | head -n 1)
          readelf -l "$JAVA_BIN" | grep "interpreter"
      shell: bash

    - uses: gradle/actions/setup-gradle@4d9f0ba0025fe599b4ebab900eb7f3a1d93ef4c2
      # https://github.com/gradle/actions/releases/latest
      with:
        cache-read-only: true

    - name: Download JNI Artifact
      uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131
      # https://github.com/actions/download-artifact/releases/latest
      with:
        name: webrtc-java-jni-${{ inputs.platform-name }}
        path: artifacts

    - name: Test
      run: |
        JNI_PATH=$(find ~+/artifacts -name "*.jar")
        ./gradlew :webrtc:test -PprebuiltJniPath="$JNI_PATH" \
          --no-daemon \
          --console=plain \
          -Dorg.gradle.native=false \
          -Dorg.gradle.vfs.watch=false \
          --stacktrace
      shell: bash
